#!/bin/bash

#-----------------------------------------------------------------------
# Name: configure
#
# Purpose: Sets macros that control conditional compilation of features
#
# Synopsis:
#
#      configure [options]
#
#      The script must be called from the Simpatico root directory
#
# Options: 
#   
# Each option enables or disables a feature. Each option takes 1 or 0 as 
# required argument, using 1 to denote enable and 0 to denote disable.
#
#   -g debugging                (defines/undefines UTIL_DEBUG)
#   -a angle potentials         (defines/undefines INTER_ANGLE)
#   -d dihedral potentials      (defines/undefines INTER_DIHEDRAL)
#   -e external potentials      (defines/undefines INTER_EXTERNAL)
#   -f free energy perturbation (defines/undefines MCMD_PERTURB)
#   -l links (mutable bonds)    (defines/undefines MCMD_LINK)
#   -s shift                    (defines/undefines MCMD_SHIFT)
#   -k dependency generation    (defines/undefines MAKEDEP)
#
# Example:
#
# To disable debugging, but enable angle and dihedral potentials:
#
#   >  ./configure -g0 -a1 -d1
#
#-----------------------------------------------------------------------
while getopts "g:a:d:e:f:l:s:k:" opt; do

  if [ -n "$MACRO" ]; then 
    MACRO=""
  fi
  if [ -n "$FILE" ]; then 
    FILE=""
  fi
  
  case $opt in
    g)
      MACRO=UTIL_DEBUG
      VALUE=1
      FILE=src/util/defines.mk
      ;;
    a)
      MACRO=INTER_ANGLE
      VALUE=1
      FILE=src/inter/defines.mk
      ;;
    d)
      MACRO=INTER_DIHEDRAL
      VALUE=1
      FILE=src/inter/defines.mk
      ;;
    e)
      MACRO=INTER_EXTERNAL
      VALUE=1
      FILE=src/inter/defines.mk
      ;;
    l)
      MACRO=MCMD_LINK
      VALUE=1
      FILE=src/mcMd/defines.mk
      ;;
    f)
      MACRO=MCMD_PERTURB
      VALUE=1
      FILE=src/mcMd/defines.mk
      ;;
    s)
      MACRO=MCMD_SHIFT
      VALUE=1
      FILE=src/mcMd/defines.mk
      ;;
    k)
      cp src/compiler.mk temp
      case $OPTARG in
      0)
        echo "Disabling automatic dependency generation" >&2
        sed "s/^ *MAKEDEP=/#MAKEDEP=/" temp > src/compiler.mk
        rm temp
        ;;
      1)
        echo "Enabling automatic dependency generation" 
        sed "s/^ *# *$MACRO=/$MACRO=/" temp > src/compiler.mk
        rm temp
        ;;
      esac
      ;;
  esac

  if [ -n "$MACRO" ]; then
    sed "s/$MACRO *=.*$/$MACRO=1/" "$FILE" > temp
    case $OPTARG in
    0)
      echo "Disabling $MACRO in file $FILE" >&2
      sed "s/^ *$MACRO=/#$MACRO=/" temp > "$FILE"
      rm temp
      ;;
    1)
      echo "Enabling $MACRO in file $FILE" >&2
      sed "s/^ *# *$MACRO=/$MACRO=/" temp > "$FILE"
      rm temp
      ;;
    esac
  fi

done
